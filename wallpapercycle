#!/bin/bash

# Find wallpapers that are at least 3840x2160 (4K)
wallpapers=$(find ~/Pictures/Wallpapers -type l -exec identify -format '%w %h %i\n' {} \; 2>/dev/null | awk '$1 >= 3840 && $2 >= 2160 {print $3}')

if [ -z "$wallpapers" ]; then
    echo "No suitable wallpapers found."
    exit 1
fi

# Convert to array
mapfile -t wallpaper_array <<< "$wallpapers"

echo "Found ${#wallpaper_array[@]} suitable wallpapers."

# Shuffle the array for random order
shuffled_array=( $(shuf -e "${wallpaper_array[@]}") )

# Cycle through wallpapers in random order
for wp in "${shuffled_array[@]}"; do
    echo "Setting wallpaper: $wp"
    feh --bg-fill "$wp"
    
    # Update the current symlink
    ln -sf "$wp" ~/Pictures/Wallpapers/current
    
    # Display message about how to quit
    echo "Press 'q' to quit, or Ctrl+C to stop. Changing wallpaper in 5 seconds..."
    
    # Wait for input with timeout
    read -t 5 -n 1 input
    if [[ "$input" == "q" ]]; then
        echo "Quitting wallpaper cycle."
        exit 0
    fi
done

echo "Finished cycling through all wallpapers."
